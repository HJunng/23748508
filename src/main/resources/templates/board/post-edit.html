<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title>게시글 수정</title>
    <script>
        // AJAX로 첨부파일 삭제 처리
        function deleteAttachment(attachmentId) {
            if (confirm('삭제하시겠습니까?')) {
                fetch(`/files/${attachmentId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                })
                    .then(response => {
                        if (response.ok) {
                            // 삭제 성공 시 해당 항목 제거
                            document.getElementById(`attachment-${attachmentId}`).remove();
                        } else {
                            alert('첨부파일 삭제에 실패했습니다.');
                        }
                    })
                    .catch(error => {
                        console.error('첨부파일 삭제 중 오류:', error);
                        alert('첨부파일 삭제 중 문제가 발생했습니다.');
                    });
            }
        }

        // 폼 제출 시 비어 있는 파일 입력 제거
        document.addEventListener('DOMContentLoaded', function () {
            const form = document.querySelector('form');
            form.addEventListener('submit', function (event) {
                const attachmentsInput = document.getElementById('attachments');
                if (attachmentsInput && attachmentsInput.files.length === 0) {
                    attachmentsInput.remove(); // 비어 있는 파일 입력 제거
                }
            });
        });

    </script>
</head>
<body>
<h1>게시글 수정</h1>

<!-- 글 수정 폼 -->
<form th:action="@{/api/posts/edit/{id}(id=${post.id})}" method="post" enctype="multipart/form-data">
    <!-- _method hidden 필드 추가 -->
    <input type="hidden" name="_method" value="PUT"/>
    <!-- 제목 -->
    <div>
        <label for="title">제목</label>
        <input type="text" id="title" name="title" th:value="${post.title}" placeholder="제목을 입력하세요" required>
    </div>

    <!-- 내용 -->
    <div>
        <label for="content">내용</label>
        <textarea id="content" name="content" placeholder="내용을 입력하세요" rows="10" th:text="${post.content}" required></textarea>
    </div>

    <!-- 첨부파일 -->
    <div>
        <!-- 기존 첨부파일 목록 -->
        <ul>
            <li th:each="attachment : ${post.attachments}" th:id="'attachment-' + ${attachment.id}">
                <a th:href="@{/files/{id}(id=${attachment.id})}"
                   th:text="${attachment.fileName}"
                   target="_blank"></a>
                <button type="button"
                        th:onclick="'deleteAttachment(' + ${attachment.id} + ')'"
                >삭제</button>
            </li>
        </ul>

        <!-- 새 첨부파일 추가 -->
        <label for="attachments">새 첨부파일 추가</label>
        <input type="file" id="attachments" name="attachments" multiple>
    </div>

    <!-- 버튼 -->
    <div>
        <button type="submit">수정 완료</button>
        <button type="button" onclick="history.back();">취소</button>
    </div>
</form>

</body>
</html>
